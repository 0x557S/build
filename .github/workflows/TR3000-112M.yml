name: OpenWrt Builder

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'OpenWrt Repository URL'
        required: true
        default: 'https://github.com/immortalwrt/immortalwrt'
      repo_branch:
        description: 'Repository Branch'
        required: true
        default: 'master'
      config_file:
        description: 'Config file name in repository (e.g., .config, x86.config)'
        required: true
        default: '.config'
      feeds_file:
        description: 'Feeds file name in repository (leave empty for OpenWrt default)'
        required: true
        default: 'feeds.conf.default'
      custom_script:
        description: 'Custom script file name (leave empty to skip)'
        required: true
        default: 'custom-script.sh'

permissions:
  contents: write
  actions: write

env:
  TZ: Asia/Shanghai
  # Optimization flags
  ENABLE_CCACHE: true
  ENABLE_MOLD_LINKER: true
  ENABLE_ZSTD_COMPRESS: true
  CCACHE_SIZE: 8G
  PARALLEL_DOWNLOADS: 16
  COMPILE_THREADS_MULTIPLIER: 2  # $(nproc) * 2

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Free Up GitHub Actions Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true


    - name: Additional Space Cleanup
      run: |
        echo "Before cleanup:"
        df -h

        # Remove more unnecessary files
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost /usr/local/graalvm /usr/local/share/powershell
        sudo rm -rf /usr/share/swift /usr/local/.ghcup
        sudo docker rmi $(docker images -q) 2>/dev/null || true
        sudo apt-get -y autoremove --purge
        sudo apt-get -y clean

        echo "After cleanup:"
        df -h

    - name: Install Dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # Use parallel downloads for apt
        echo 'Acquire::Queue-Mode "access";' | sudo tee /etc/apt/apt.conf.d/99parallel
        echo 'APT::Acquire::Retries "3";' | sudo tee -a /etc/apt/apt.conf.d/99parallel

        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext \
          gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 \
          libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
          libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev \
          lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pip python3-ply python3-docutils python3-pyelftools qemu-utils re2c \
          rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget \
          xmlto xxd zlib1g-dev zstd pigz

        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"

        # Install latest mold linker for faster linking
        MOLD_VERSION=$(curl -s https://api.github.com/repos/rui314/mold/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
        wget -q https://github.com/rui314/mold/releases/download/${MOLD_VERSION}/mold-${MOLD_VERSION#v}-x86_64-linux.tar.gz
        sudo tar -xzf mold-*.tar.gz -C /usr/local --strip-components=1
        rm mold-*.tar.gz

        # Verify installations
        ccache --version
        mold --version

        # Setup ccache directory
        mkdir -p ~/.ccache

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ github.event.inputs.repo_branch }}-${{ github.run_number }}
        restore-keys: |
          ccache-${{ github.event.inputs.repo_branch }}-
          ccache-

    - name: Cache OpenWrt Source
      id: cache-source
      uses: actions/cache@v4
      with:
        path: openwrt
        key: openwrt-source-${{ github.event.inputs.repo_url }}-${{ github.event.inputs.repo_branch }}-${{ github.run_number }}
        restore-keys: |
          openwrt-source-${{ github.event.inputs.repo_url }}-${{ github.event.inputs.repo_branch }}-

    - name: Clone OpenWrt Source
      if: steps.cache-source.outputs.cache-hit != 'true'
      run: |
        df -h
        git clone --depth 1 --single-branch --filter=blob:none \
          -b ${{ github.event.inputs.repo_branch }} \
          ${{ github.event.inputs.repo_url }} openwrt

    - name: Update Existing Source
      if: steps.cache-source.outputs.cache-hit == 'true'
      run: |
        cd openwrt
        git fetch --depth 1 origin ${{ github.event.inputs.repo_branch }}
        git reset --hard FETCH_HEAD

    - name: Set Environment
      run: |
        echo "OPENWRT_PATH=$GITHUB_WORKSPACE/openwrt" >> $GITHUB_ENV

    - name: Apply Custom Feeds Configuration
      run: |
        cd openwrt
        FEEDS_FILE="${{ github.event.inputs.feeds_file }}"

        if [ -n "$FEEDS_FILE" ] && [ -f "$GITHUB_WORKSPACE/$FEEDS_FILE" ]; then
          echo "âœ… Using feeds file: $FEEDS_FILE"
          cp "$GITHUB_WORKSPACE/$FEEDS_FILE" feeds.conf.default
        else
          echo "â„¹ï¸  Using default feeds.conf.default from OpenWrt source"
        fi

        echo "=== feeds.conf.default ==="
        cat feeds.conf.default

    - name: Cache Feeds
      id: cache-feeds
      uses: actions/cache@v4
      with:
        path: |
          openwrt/feeds
          openwrt/package/feeds
        key: openwrt-feeds-${{ github.event.inputs.repo_branch }}-${{ hashFiles('openwrt/feeds.conf.default') }}
        restore-keys: |
          openwrt-feeds-${{ github.event.inputs.repo_branch }}-

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Custom Configuration
      run: |
        cd openwrt
        CONFIG_FILE="${{ github.event.inputs.config_file }}"

        if [ -z "$CONFIG_FILE" ]; then
          echo "âŒ ERROR: No config file specified!"
          echo "Please provide a config file name (e.g., .config, tr3000.config)"
          exit 1
        fi

        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "âŒ ERROR: Config file not found: $CONFIG_FILE"
          echo "Available files in repository:"
          ls -la $GITHUB_WORKSPACE/*.config 2>/dev/null || echo "No .config files found"
          exit 1
        fi

        echo "âœ… Using config file: $CONFIG_FILE"
        cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config

        echo "=== .config preview (first 50 lines) ==="
        head -50 .config

        make defconfig

        echo "=== Target device ==="
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config || echo "No specific device selected"

    - name: Pre-download Toolchain
      run: |
        cd openwrt
        make toolchain/install -j$(nproc) BUILD_LOG=1 || true

    - name: Download Packages
      run: |
        cd openwrt
        # Parallel download with retries
        make download -j16 V=s DOWNLOAD_ATTEMPTS=5
        find dl -size -1024c -exec rm -f {} \;

    - name: Cache Downloaded Packages
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: openwrt-dl-${{ github.event.inputs.repo_branch }}-${{ hashFiles('openwrt/.config') }}
        restore-keys: |
          openwrt-dl-${{ github.event.inputs.repo_branch }}-

    - name: Cache Build Directory
      uses: actions/cache@v4
      with:
        path: |
          openwrt/build_dir/host
          openwrt/build_dir/hostpkg
          openwrt/staging_dir/host
          openwrt/staging_dir/hostpkg
        key: openwrt-staging-${{ github.event.inputs.repo_branch }}-${{ hashFiles('openwrt/.config') }}
        restore-keys: |
          openwrt-staging-${{ github.event.inputs.repo_branch }}-

    - name: Pre-compile Cleanup
      run: |
        echo "Disk space before cleanup:"
        df -h

        # Clean up apt cache
        sudo apt-get clean

        # Remove build artifacts from previous runs if any
        cd openwrt
        make clean 2>/dev/null || true
        rm -rf tmp/ 2>/dev/null || true

        echo "Disk space after cleanup:"
        df -h

    - name: Run Custom Script
      run: |
        SCRIPT_FILE="${{ github.event.inputs.custom_script }}"

        if [ -n "$SCRIPT_FILE" ] && [ -f "$GITHUB_WORKSPACE/$SCRIPT_FILE" ]; then
          echo "âœ… Running custom script: $SCRIPT_FILE"
          chmod +x "$GITHUB_WORKSPACE/$SCRIPT_FILE"
          cd openwrt
          "$GITHUB_WORKSPACE/$SCRIPT_FILE"
        else
          echo "â„¹ï¸  No custom script specified or file not found, skipping..."
        fi

    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        echo "Building with $(nproc) threads"
        echo "Current directory space:"
        df -h .

        # Optimize compilation flags
        export PATH="/usr/lib/ccache:$PATH"
        export CCACHE_DIR=~/.ccache
        export CCACHE_COMPRESS=1
        export CCACHE_COMPRESSLEVEL=6
        export FORCE_UNSAFE_CONFIGURE=1

        # Use mold linker if available (faster than ld)
        if command -v mold &> /dev/null; then
          export LDFLAGS="-fuse-ld=mold"
        fi

        # Parallel make with aggressive threading
        make -j$(($(nproc)*2)) \
          IGNORE_ERRORS='' \
          BUILD_LOG=1 \
          || {
            echo "First attempt failed, cleaning up and retrying..."
            df -h
            rm -rf tmp/
            make -j1 V=s
          }

        echo "status=success" >> $GITHUB_OUTPUT
        echo "compile_time=$(date +"%Y%m%d_%H%M%S")" >> $GITHUB_OUTPUT

        # Extract device name
        DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | \
          sed -r 's/.*DEVICE_(.*)=y/\1/' | head -n1)
        echo "device_name=${DEVICE_NAME:-unknown}" >> $GITHUB_OUTPUT

    - name: Check Disk Space
      if: always()
      run: df -h

    - name: Organize Firmware Files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        # Find the target directory safely
        FIRMWARE_DIR=$(find openwrt/bin/targets -type d -maxdepth 2 -name "*" | grep -E 'openwrt/bin/targets/[^/]+/[^/]+$' | head -n1)
        if [ -z "$FIRMWARE_DIR" ]; then
          echo "âŒ ERROR: Could not find firmware directory"
          exit 1
        fi
        
        cd "$FIRMWARE_DIR"
        rm -rf packages

        FIRMWARE_PATH=$PWD
        echo "firmware_path=$FIRMWARE_PATH" >> $GITHUB_OUTPUT
        ls -lh

        # Generate detailed build info
        cat > $FIRMWARE_PATH/build-info.txt << EOF
        Build Date: $(date '+%Y-%m-%d %H:%M:%S %Z')
        Source: ${{ github.event.inputs.repo_url }}
        Branch: ${{ github.event.inputs.repo_branch }}
        Device: ${{ steps.compile.outputs.device_name }}
        Commit: $(cd $GITHUB_WORKSPACE/openwrt && git rev-parse --short HEAD)
        Workflow: ${{ github.workflow }} #${{ github.run_number }}
        Builder: GitHub Actions (ubuntu-latest)
        Compiler: $(gcc --version | head -n1)
        Ccache Stats: $(ccache -s | grep -E 'cache hit|cache miss' || echo 'N/A')
        EOF

        # Generate checksums
        cd $FIRMWARE_PATH
        sha256sum *.bin *.img 2>/dev/null > sha256sums.txt || true

        echo "status=success" >> $GITHUB_OUTPUT

        # Clean up build artifacts after organizing files
        echo "Cleaning build artifacts to free space..."
        cd $GITHUB_WORKSPACE/openwrt
        rm -rf build_dir/target-* staging_dir/target-* tmp/ logs/
        echo "After cleanup:"
        df -h

    - name: Upload Firmware to Artifacts
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_${{ steps.compile.outputs.device_name }}_${{ steps.compile.outputs.compile_time }}
        path: ${{ steps.organize.outputs.firmware_path }}
        retention-days: 7
        compression-level: 9

    - name: Generate Release Tag and Notes
      id: release_tag
      if: steps.organize.outputs.status == 'success'
      run: |
        RELEASE_TAG="v$(date +"%Y.%m.%d-%H%M")"
        echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

        cat > release-notes.md << EOF
        ## OpenWrt Firmware Release

        **Build Date:** $(date '+%Y-%m-%d %H:%M:%S %Z')
        **Device:** ${{ steps.compile.outputs.device_name }}
        **Source:** [${{ github.event.inputs.repo_url }}](${{ github.event.inputs.repo_url }})
        **Branch:** \`${{ github.event.inputs.repo_branch }}\`
        **Commit:** \`$(cd openwrt && git rev-parse --short HEAD)\`

        ### ðŸ“¦ Files Included

        $(cd ${{ steps.organize.outputs.firmware_path }} && ls -1 | sed 's/^/- /')

        ### ðŸ”§ Build Information

        - Workflow Run: #${{ github.run_number }}
        - Compiler: GCC with ccache
        - Build System: Ubuntu Latest (GitHub Actions)

        ---
        ðŸ¤– *Automated build by GitHub Actions*
        EOF

        echo "status=success" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: steps.release_tag.outputs.status == 'success'
      with:
        tag_name: ${{ steps.release_tag.outputs.tag }}
        name: OpenWrt ${{ steps.compile.outputs.device_name }} - ${{ steps.compile.outputs.compile_time }}
        body_path: release-notes.md
        files: |
          ${{ steps.organize.outputs.firmware_path }}/*
          ${{ steps.organize.outputs.firmware_path }}/build-info.txt
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean Up Old Releases
      uses: dev-drprasad/delete-older-releases@v0.3.4
      if: steps.release_tag.outputs.status == 'success'
      continue-on-error: true
      with:
        keep_latest: 5
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean Up Old Workflow Runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Final Space Check
      if: always()
      run: |
        echo "=== Final Disk Space ==="
        df -h
        echo "=== ccache Statistics ==="
        ccache -s || true
